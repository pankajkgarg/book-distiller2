<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DistillBoard — Autopilot</title>
  <link rel="stylesheet" href="./styles.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="row" style="padding:10px 0" v-scope>
        <div style="font-weight:700;font-size:16px">DistillBoard — Autopilot</div>
        <div class="grow"></div>
        <button class="btn primary" :disabled="running" @click="start">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4.5 5.653c0-1.262 1.36-2.037 2.454-1.35l10.5 6.347a1.5 1.5 0 010 2.6l-10.5 6.347A1.5 1.5 0 014.5 18.647V5.653z"/></svg>
          Start
        </button>
        <button class="btn" :disabled="!running" @click="togglePause">
          <svg v-if="!paused" class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6.75 5.25h3v13.5h-3zM14.25 5.25h3v13.5h-3z"/></svg>
          <svg v-else class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 5.653c0-1.262 1.36-2.037 2.454-1.35l10.5 6.347a1.5 1.5 0 010 2.6l-10.5 6.347A1.5 1.5 0 014.5 18.647V5.653z"/></svg>
          {{ paused ? 'Resume' : 'Pause' }}
        </button>
        <button class="btn" :disabled="!running" @click="stop">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
          Stop
        </button>
        <button class="btn" :disabled="running || history.filter(h=>h.role==='model').length===0" @click="openExport">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 16.5v2.25A1.5 1.5 0 004.5 20.25h15A1.5 1.5 0 0021 18.75V16.5"/><path d="M12 3v12m0 0l4.5-4.5M12 15l-4.5-4.5"/></svg>
          Export
        </button>
        <button class="btn ghost" @click="toggleTrace">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 6h16M4 12h10M4 18h7"/></svg>
          Trace ⟷
        </button>
        <select v-model="themeMode" @change="onThemeChange" style="padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:var(--surface);color:var(--fg)">
          <option value="auto">Theme: Auto</option>
          <option value="dark">Theme: Dark</option>
          <option value="light">Theme: Light</option>
        </select>
        <button class="btn" @click="openInfo">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><path d="M12 8h.01M11 11h2v5h-2z"/></svg>
          Info
        </button>
      </div>
      <div class="row" style="padding:0 0 10px 0;font-size:13px" v-scope>
        <div class="status">Status: <span>{{ status }}</span></div>
        <div class="status">• sections: <span>{{ sections }}</span></div>
        <div class="status">• tokens: <span>{{ tokenTally }}</span></div>
        <div class="status">• end marker: <span class="kbd">&lt;{{ endMarkerEscaped }}&gt;</span></div>
        <div class="grow"></div>
        <div class="status" v-if="paused && lastErrorMessage">
          <span class="pill bad" :title="lastErrorMessage">Error: {{ (lastErrorMessage||'').slice(0,80) }}</span>
          <button class="btn" style="margin-left:8px" @click="resumeOrStart">Resume</button>
        </div>
        <div class="status" v-if="retrying">
          <span class="pill" :title="lastErrorMessage || 'Temporary issue'"><span class="spinner"></span> Retrying in {{ Math.ceil(retryRemainingMs/1000) }}s ({{ retryAttempt+1 }}/{{ retryMax }}) — {{ (lastErrorMessage||'').slice(0,80) }}</span>
        </div>
        <div class="muted">Edit the prompt anytime; applies next turn.</div>
        <span style="display:none" v-effect="persist(); applyTheme()"></span>
      </div>
    </div>
  </div>

  <div class="container grid" v-scope>
    <!-- LEFT -->
    <div class="card">
      <div class="head">Source & Prompt</div>
      <div class="body">
        <label>Gemini API Key</label>
        <div class="row">
          <input v-model="apiKey" type="password" placeholder="••••••••••••••••••••••" />
          <button class="btn" @click="saveKey">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M16.5 10.5a4.5 4.5 0 10-9 0 4.5 4.5 0 009 0z"/><path d="M21 21l-4.35-4.35"/></svg>
            Save
          </button>
          <button class="btn" @click="clearKey">Clear</button>
        </div>
        <div class="muted" style="margin-top:4px">Stored locally in your browser.</div>

        <div class="row" style="gap:8px; margin-top:12px">
          <div style="flex:1">
            <label style="margin-top:0">Model</label>
            <select v-model="model" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#fff">
              <option value="gemini-2.5-pro">gemini-2.5-pro</option>
              <option value="gemini-2.5-flash">gemini-2.5-flash</option>
              <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
            </select>
          </div>
          <div style="width:240px">
            <label style="margin-top:0">Temperature</label>
            <div class="row" style="gap:8px">
              <label style="font-weight:500"><input type="checkbox" v-model="useTemperature"> Enable</label>
              <input :disabled="!useTemperature" v-model.number="temperature" type="number" min="0" max="2" step="0.1" style="width:120px">
            </div>
          </div>
        </div>

        <label style="margin-top:12px">Upload (.pdf or .epub)</label>
        <input id="fileInput" type="file" accept=".pdf,.epub" @change="onFileChange" />
        <div class="muted" style="margin-top:6px">{{ fileInfo }}</div>

        <label style="margin-top:12px">Distillation Prompt (editable)</label>
        <textarea v-model="prompt"></textarea>

        <div style="margin-top:10px;font-weight:600">Run options</div>
        <label style="margin-top:8px"><input type="checkbox" v-model="pauseOnAnomaly"> Pause on anomaly (refusal/empty/loop)</label>
        <div class="row" style="margin-top:6px;gap:8px">
          <div style="flex:1">
            <div class="muted">End marker regex</div>
            <input v-model="endMarker">
          </div>
          <div>
            <div class="muted">Budget: tokens</div>
            <input v-model.number="budgetTokens" type="number" min="0" placeholder="(optional)" style="width:140px">
          </div>
          <div>
            <div class="muted">Budget: time (sec)</div>
            <input v-model.number="budgetTime" type="number" min="0" placeholder="(optional)" style="width:140px">
          </div>
        </div>
        <div class="muted" style="margin-top:8px">No chunking. The book file is uploaded once and re-attached on every turn. Exact request & response are logged in Trace.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="display:flex;flex-direction:column">
      <div class="head">Live Document</div>
      <div class="doc" id="liveDoc"><div class="muted">Output will appear here…</div></div>
    </div>
  </div>

  <!-- Trace Drawer -->
  <div id="trace" class="trace" aria-hidden="true" v-scope>
    <div class="head">
      <div style="font-weight:700">Trace</div>
      <div class="grow"></div>
      <button class="btn" @click="closeTrace">Close</button>
      <button class="btn" @click="downloadTrace">Download trace.json</button>
    </div>
    <div id="traceList" class="list"></div>
  </div>

  <!-- Export modal -->
  <dialog id="exportModal" style="border:none;border-radius:12px;max-width:680px;width:calc(100% - 24px)" v-scope>
    <form method="dialog" style="margin:0">
      <div class="card">
        <div class="head">Export</div>
        <div class="body">
          <label><input id="includeTrace" type="checkbox"> Include trace.json</label>
          <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn primary" @click="copyAll">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M8 7h10a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2V9a2 2 0 012-2z"/><path d="M6 3h10a2 2 0 012 2v2"/></svg>
              Copy all
            </button>
            <button type="button" class="btn" @click="exportMd">.md</button>
            <button type="button" class="btn" @click="exportTxt">.txt</button>
            <button type="button" class="btn" @click="exportPdf">.pdf</button>
            <button id="btnCloseExport" class="btn">Close</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Info modal -->
  <dialog id="infoModal" style="border:none;border-radius:12px;max-width:640px;width:calc(100% - 24px)">
    <form method="dialog" style="margin:0">
      <div class="card">
        <div class="head">About & How-To</div>
        <div class="body">
          <div style="font-weight:600;margin-bottom:6px">Tech Stack</div>
          <ul class="muted" style="margin:0 0 12px 18px">
            <li>Petite‑Vue for UI reactivity</li>
            <li>Google Gemini SDK (@google/genai)</li>
            <li>Marked for Markdown → HTML, jsPDF for PDF export</li>
          </ul>
          <div style="font-weight:600;margin:8px 0 6px">Recreate this with GPT‑5 (or latest)</div>
          <div class="muted">
            1) Build a simple HTML app with Petite‑Vue and a file input. 2) Capture the book file and prompt, then call the OpenAI Responses API with your chosen model (e.g., GPT‑5 when available) and attach the file each turn. 3) Stream responses into a live document and keep a trace log for debugging. Persist API key, model, and prompt in localStorage.
          </div>
          <div style="margin-top:12px;text-align:right">
            <button class="btn">Close</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <div id="toasts" class="toastHost"></div>

  <script type="module" src="./app.js"></script>
</body>
</html>
