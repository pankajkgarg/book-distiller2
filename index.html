<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DistillBoard — Autopilot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="topbar">
    <div class="container">
      <div class="row" style="padding:12px 0" v-scope>
        <div style="font-weight:700;font-size:16px;margin-right:12px">DistillBoard</div>

        <button class="btn primary" :disabled="running" @click="start">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M4.5 5.653c0-1.262 1.36-2.037 2.454-1.35l10.5 6.347a1.5 1.5 0 010 2.6l-10.5 6.347A1.5 1.5 0 014.5 18.647V5.653z" />
          </svg>
          Start
        </button>

        <button class="btn" :disabled="!running" @click="togglePause">
          <svg v-if="!paused" class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6.75 5.25h3v13.5h-3zM14.25 5.25h3v13.5h-3z" />
          </svg>
          <svg v-else class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M4.5 5.653c0-1.262 1.36-2.037 2.454-1.35l10.5 6.347a1.5 1.5 0 010 2.6l-10.5 6.347A1.5 1.5 0 014.5 18.647V5.653z" />
          </svg>
          {{ paused ? 'Resume' : 'Pause' }}
        </button>

        <button class="btn" :disabled="!running" @click="stop">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 6h12v12H6z" />
          </svg>
          Stop
        </button>

        <div class="grow"></div>

        <button class="btn" :disabled="running || history.filter(h=>h.role==='model').length===0" @click="openExport"
          title="Export">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M3 16.5v2.25A1.5 1.5 0 004.5 20.25h15A1.5 1.5 0 0021 18.75V16.5" />
            <path d="M12 3v12m0 0l4.5-4.5M12 15l-4.5-4.5" />
          </svg>
          <span class="hide-mobile">Export</span>
        </button>

        <button class="btn ghost" @click="toggleTrace" title="Trace">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M4 6h16M4 12h10M4 18h7" />
          </svg>
        </button>

        <button class="btn ghost" @click="onThemeChange" title="Toggle Theme">
          <svg v-if="themeMode==='dark'" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
          </svg>
          <svg v-else class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="5" />
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
          </svg>
        </button>

        <button class="btn ghost" @click="openInfo" title="Info">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="9" />
            <path d="M12 8h.01M11 11h2v5h-2z" />
          </svg>
        </button>
      </div>
      <div class="row" style="padding:0 0 10px 0;font-size:13px" v-scope>
        <div class="status" style="display:flex;align-items:center;gap:6px">
          <span class="status-badge"
            :class="{ running: running && !paused, good: status==='complete', warn: paused || /paused/i.test(status), bad: /error/i.test(status) }">
            <span v-if="running && !paused" class="spinner sm" aria-hidden="true"></span>
            <span aria-live="polite">{{ status }}</span>
          </span>
        </div>
        <div class="status">• sections: <span>{{ sections }}</span></div>
        <div class="status">• tokens: <span>{{ tokenTally }}</span></div>
        <div class="grow"></div>
        <div class="status" v-if="paused">
          <span v-if="lastErrorMessage" class="pill bad" :title="lastErrorMessage">Error: {{
            (lastErrorMessage||'').slice(0,80) }}</span>
          <button class="btn" style="margin-left:8px" @click="resumeOrStart">Resume</button>
        </div>
        <div class="status" v-if="retrying" style="display:flex;align-items:center;gap:8px">
          <span class="pill" :title="lastErrorMessage || 'Temporary issue'"><span class="spinner"></span> Retrying in {{
            Math.ceil(retryRemainingMs/1000) }}s ({{ retryAttempt+1 }}/{{ retryMax }}) — {{
            (lastErrorMessage||'').slice(0,80) }}</span>
          <div class="retrybar" :title="`Retrying in ${Math.ceil(retryRemainingMs/1000)}s`">
            <div class="fill"
              :style="{ width: (retryPlannedMs>0? Math.max(0, Math.min(100, Math.round(100*(retryPlannedMs - retryRemainingMs)/retryPlannedMs))) : 0) + '%' }">
            </div>
          </div>
          <span class="sr-only" aria-live="polite">Retrying in {{ Math.ceil(retryRemainingMs/1000) }} seconds, attempt
            {{ retryAttempt+1 }} of {{ retryMax }}.</span>
        </div>
        <div class="status" v-if="autoWaiting" style="display:flex;align-items:center;gap:8px">
          <span class="pill"><span class="spinner"></span> Auto wait {{ Math.ceil(autoWaitRemainingMs/1000) }}s before
            next request</span>
          <div class="retrybar" :title="`Auto wait ${Math.ceil(autoWaitRemainingMs/1000)}s`">
            <div class="fill"
              :style="{ width: (autoWaitPlannedMs>0? Math.max(0, Math.min(100, Math.round(100*(autoWaitPlannedMs - autoWaitRemainingMs)/autoWaitPlannedMs))) : 0) + '%' }">
            </div>
          </div>
          <span class="sr-only" aria-live="polite">Automatically waiting {{ Math.ceil(autoWaitRemainingMs/1000) }}
            seconds before the next request.</span>
        </div>
        <div class="muted">Edit the prompt anytime; applies next turn.</div>
        <span style="display:none" v-effect="persist(); applyTheme()"></span>
      </div>
    </div>
  </div>

  <div class="container grid" v-scope>
    <!-- LEFT -->
    <div class="card">
      <div class="head">Source & Settings</div>
      <div class="body">
        <!-- Upload Zone -->
        <div class="upload-zone" @click="document.getElementById('fileInput').click()"
          :class="{ 'has-file': !!fileBlob }">
          <input id="fileInput" type="file" accept=".pdf,.epub" @change="onFileChange" style="display:none" />
          <div v-if="!fileBlob" style="text-align:center">
            <svg class="icon" style="width:32px;height:32px;color:var(--accent);margin-bottom:8px" viewBox="0 0 24 24"
              fill="none" stroke="currentColor">
              <path d="M12 12v6m0-6V6m0 6H6m6 0h6" />
            </svg>
            <div style="font-weight:600">Click to upload book</div>
            <div class="muted" style="font-size:12px">.pdf or .epub</div>
          </div>
          <div v-else style="display:flex;align-items:center;gap:12px;width:100%">
            <div style="background:var(--surface-alt);padding:8px;border-radius:8px">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                <path d="M14 2v6h6" />
                <path d="M16 13H8" />
                <path d="M16 17H8" />
                <path d="M10 9H8" />
              </svg>
            </div>
            <div style="flex:1;overflow:hidden">
              <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ fileBlob.name }}
              </div>
              <div class="muted" style="font-size:12px">{{ (fileBlob.size/1048576).toFixed(2) }} MB</div>
            </div>
            <button class="btn ghost" style="padding:4px"
              @click.stop="document.getElementById('fileInput').click()">Change</button>
          </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
          <label style="margin:0">Distillation Prompt</label>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" style="padding:2px 8px;height:auto;font-size:12px" @click="savePrompt">Save as...</button>
          </div>
        </div>

        <!-- Saved Prompts Dropdown -->
        <div v-if="savedPrompts.length > 0" style="margin-bottom:8px;margin-top:4px">
          <select @change="loadPrompt(savedPrompts[$event.target.value])" style="font-size:13px">
            <option disabled selected>Select a saved prompt...</option>
            <option v-for="(p, i) in savedPrompts" :key="i" :value="i">
              {{ p.label }}
            </option>
          </select>
        </div>

        <!-- Saved Prompts List (Mini Manager) -->
        <details v-if="savedPrompts.length > 0" style="margin-bottom:8px">
          <summary style="font-size:12px;cursor:pointer;color:var(--text-muted)">Manage saved prompts</summary>
          <div style="margin-top:4px;border:1px solid var(--line);border-radius:8px;padding:8px;background:var(--surface-alt)">
            <div v-for="(p, i) in savedPrompts" :key="i"
              style="display:flex;align-items:center;justify-content:space-between;font-size:12px;margin-bottom:4px">
              <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px" :title="p.text">{{ p.label }}</span>
              <button class="btn ghost" style="padding:2px 6px;height:auto;font-size:11px"
                @click="deletePrompt(i)">Delete</button>
            </div>
          </div>
        </details>

        <textarea v-model="prompt" placeholder="Enter your instructions here..."></textarea>

        <!-- Settings Toggle -->
        <details class="settings-details" :open="isSettingsOpen" @toggle="isSettingsOpen = $el.open">
          <summary>
            <span>Settings & API Key</span>
            <svg class="icon chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M6 9l6 6 6-6" />
            </svg>
          </summary>

          <div style="padding-top:12px">
            <label style="margin-top:0">Gemini API Key</label>

            <!-- Saved Keys Dropdown -->
            <div v-if="savedKeys.length > 0" style="margin-bottom:8px">
              <select @change="loadKey(savedKeys[$event.target.value])" style="font-size:13px">
                <option disabled selected>Select a saved key...</option>
                <option v-for="(k, i) in savedKeys" :key="i" :value="i">
                  {{ k.label }} ({{ k.key.slice(0,4) }}...{{ k.key.slice(-4) }})
                </option>
              </select>
            </div>

            <div class="row">
              <input v-model="apiKey" type="password" placeholder="••••••••••••••••••••••" />
              <button class="btn" @click="saveKey">Save</button>
              <button class="btn ghost" @click="clearKey">Clear</button>
            </div>

            <!-- Key List (Mini Manager) -->
            <div v-if="savedKeys.length > 0"
              style="margin-top:8px;border:1px solid var(--line);border-radius:8px;padding:8px;background:var(--surface-alt)">
              <div style="font-size:12px;font-weight:600;margin-bottom:4px">Saved Keys</div>
              <div v-for="(k, i) in savedKeys" :key="i"
                style="display:flex;align-items:center;justify-content:space-between;font-size:12px;margin-bottom:4px">
                <span>{{ k.label }}</span>
                <button class="btn ghost" style="padding:2px 6px;height:auto;font-size:11px"
                  @click="deleteKey(i)">Delete</button>
              </div>
            </div>

            <div class="muted" style="font-size:12px;margin-top:4px">Stored locally in your browser.</div>

            <label>Model</label>
            <select v-model="model">
              <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
              <option value="gemini-2.5-pro">gemini-2.5-pro</option>
              <option value="gemini-2.5-flash">gemini-2.5-flash</option>
              <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
            </select>

            <div style="margin-top:16px;border-top:1px solid var(--line);padding-top:12px">
              <div style="font-weight:600;font-size:13px;margin-bottom:8px">Advanced</div>
              <div class="row" style="flex-wrap:wrap">
                <label class="row" style="margin:0;font-weight:400"><input type="checkbox" v-model="useTemperature">
                  Temperature</label>
                <input :disabled="!useTemperature" v-model.number="temperature" type="number" min="0" max="2" step="0.1"
                  style="width:80px">
              </div>
              <label class="row" style="margin:8px 0 0;font-weight:400"><input type="checkbox" v-model="pauseOnAnomaly">
                Pause on anomaly</label>
              <label class="row" style="margin:4px 0 0;font-weight:400"><input type="checkbox"
                  v-model="autoWaitBetweenRequests"> Auto wait 60s</label>

              <div class="row" style="margin-top:8px">
                <div style="flex:1">
                  <div class="muted" style="font-size:12px">End marker</div>
                  <input v-model="endMarker" style="font-size:12px">
                </div>
                <div style="flex:1">
                  <div class="muted" style="font-size:12px">Budget (tokens)</div>
                  <input v-model.number="budgetTokens" type="number" style="font-size:12px">
                </div>
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="display:flex;flex-direction:column">
      <div class="head">Live Document</div>
      <div class="doc" id="liveDoc">
        <div v-if="sectionsMeta.length===0" class="muted">Output will appear here…</div>
        <div v-else>
          <div class="section" v-for="(meta, i) in sectionsMeta" :key="meta.id" :data-sid="String(meta.id)">
            <div class="sectionHead">
              <div class="sectionTitle">
                Section {{ i+1 }}: {{ getTitleFromMd(meta.text) }}
                <span v-if="Number.isFinite(Number(meta?.candidatesTokenCount))" class="muted"
                  style="margin-left:8px">tokens: {{ Number(meta.candidatesTokenCount) }}</span>
              </div>
              <button class="btn ghost" @click="deleteSection(meta.id)">Delete</button>
            </div>
            <div class="sectionBody">
              <div class="prose" v-html="renderMd(meta.text)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trace Drawer -->
  <div id="trace" class="trace" aria-hidden="true" v-scope>
    <div class="head">
      <div style="font-weight:700">Trace</div>
      <div class="grow"></div>
      <button class="btn" @click="closeTrace">Close</button>
      <button class="btn" @click="downloadTrace">Download trace.json</button>
    </div>
    <div id="traceList" class="list">
      <div class="item" v-for="t in trace.slice().reverse()" :key="t.ts">
        <div><b>{{ t.error ? 'Error' : 'Turn' }}</b> <span class="muted" style="float:right">{{ new
            Date(t.ts).toLocaleTimeString() }}</span></div>
        <div class="muted">Request:</div>
        <div class="pre">{{ stringify(t.request) }}</div>
        <template v-if="t.response">
          <div class="muted">Response:</div>
          <div class="pre">{{ stringify(t.response) }}</div>
        </template>
        <template v-if="t.error">
          <div class="muted">Error:</div>
          <div class="pre">{{ stringify(t.error) }}</div>
        </template>
        <div class="muted" v-if="t.retries>0">Retries: {{ t.retries }}</div>
      </div>
    </div>
  </div>

  <!-- Export modal -->
  <dialog id="exportModal" style="border:none;border-radius:12px;max-width:680px;width:calc(100% - 24px)" v-scope>
    <form method="dialog" style="margin:0">
      <div class="card">
        <div class="head">Export</div>
        <div class="body">
          <label><input id="includeTrace" type="checkbox"> Include trace.json</label>
          <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn primary" @click="copyAll">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M8 7h10a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2V9a2 2 0 012-2z" />
                <path d="M6 3h10a2 2 0 012 2v2" />
              </svg>
              Copy all
            </button>
            <button type="button" class="btn" @click="exportMd">.md</button>
            <button type="button" class="btn" @click="exportTxt">.txt</button>
            <button type="button" class="btn" @click="exportPdf">.pdf</button>
            <button id="btnCloseExport" class="btn">Close</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Info modal -->
  <dialog id="infoModal" style="border:none;border-radius:12px;max-width:640px;width:calc(100% - 24px)">
    <form method="dialog" style="margin:0">
      <div class="card">
        <div class="head">About & How-To</div>
        <div class="body">
          <div style="font-weight:600;margin-bottom:6px">Tech Stack</div>
          <ul class="muted" style="margin:0 0 12px 18px">
            <li>Petite‑Vue for UI reactivity</li>
            <li>Google Gemini SDK (@google/genai)</li>
            <li>Marked for Markdown → HTML, jsPDF for PDF export</li>
          </ul>
          <div style="font-weight:600;margin:8px 0 6px">Recreate this with GPT‑5 (or latest)</div>
          <div class="muted">
            1) Build a simple HTML app with Petite‑Vue and a file input. 2) Capture the book file and prompt, then call
            the OpenAI Responses API with your chosen model (e.g., GPT‑5 when available) and attach the file each turn.
            3) Stream responses into a live document and keep a trace log for debugging. Persist API key, model, and
            prompt in localStorage.
          </div>
          <div style="margin-top:12px;text-align:right">
            <button class="btn">Close</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <div id="toasts" class="toastHost"></div>

  <script type="module" src="./app.js"></script>
</body>

</html>