<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DistillBoard — Autopilot</title>
  <style>
    :root{--bg:#ffffff;--fg:#0f172a;--muted:#64748b;--line:#e2e8f0;--accent:#2563eb;--accent-2:#1e3a8a}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1260px;margin:0 auto;padding:12px}
    .topbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--fg);padding:6px 10px;border-radius:8px;cursor:pointer;display:inline-flex;gap:6px;align-items:center}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{border-color:transparent;background:transparent}
    .status{color:var(--muted)}
    .kbd{font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;border:1px solid var(--line);border-bottom-width:2px;border-radius:6px;padding:0 .35rem;background:#f8fafc}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:12px;margin-top:12px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
    .card .head{padding:10px 12px;border-bottom:1px solid var(--line);font-weight:600}
    .card .body{padding:12px}
    label{display:block;font-size:13px;margin:10px 0 6px;font-weight:600}
    input[type="text"],input[type="number"],input[type="password"],textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--line);font:inherit;background:#fff}
    input[type="file"]{font-size:13px}
    textarea{min-height:180px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .muted{color:var(--muted)}
    .doc{height:calc(100vh - 220px);overflow:auto;padding:16px}
    .prose{max-width:100%}
    .prose blockquote{margin:10px 0;padding:8px 12px;border-left:4px solid var(--line);background:#f8fafc;color:#334155}
    .trace{position:fixed;right:0;top:0;height:100vh;width:min(520px,100%);background:#fff;border-left:1px solid var(--line);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
    .trace.open{transform:none}
    .trace .head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
    .trace .list{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
    .trace .item{border:1px solid var(--line);border-radius:8px;padding:10px}
    .pre{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px solid var(--line);border-radius:8px;padding:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px}
    .toastHost{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:6px;z-index:50}
    .toast{padding:8px 10px;border-radius:8px;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,.1)}
    .toast.info{background:#0ea5e9}.toast.good{background:#059669}.toast.warn{background:#d97706}.toast.bad{background:#dc2626}
    .icon{width:18px;height:18px;display:inline-block}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- Petite-Vue (tiny Vue variant) -->
  <script type="module" src="https://unpkg.com/petite-vue?module"></script>
  <!-- Google Gemini SDK (@google/genai) via ESM -->
  <script type="module" src="https://esm.run/@google/genai@0.14.1"></script>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="row" style="padding:10px 0" v-scope>
        <div style="font-weight:700;font-size:16px">DistillBoard — Autopilot</div>
        <div class="grow"></div>
        <button class="btn primary" :disabled="running" @click="start">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4.5 5.653c0-1.262 1.36-2.037 2.454-1.35l10.5 6.347a1.5 1.5 0 010 2.6l-10.5 6.347A1.5 1.5 0 014.5 18.647V5.653z"/></svg>
          Start
        </button>
        <button class="btn" :disabled="!running" @click="togglePause">
          <svg v-if="!paused" class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6.75 5.25h3v13.5h-3zM14.25 5.25h3v13.5h-3z"/></svg>
          <svg v-else class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 5.653c0-1.262 1.36-2.037 2.454-1.35l10.5 6.347a1.5 1.5 0 010 2.6l-10.5 6.347A1.5 1.5 0 014.5 18.647V5.653z"/></svg>
          {{ paused ? 'Resume' : 'Pause' }}
        </button>
        <button class="btn" :disabled="!running" @click="stop">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
          Stop
        </button>
        <button class="btn" :disabled="running || history.filter(h=>h.role==='model').length===0" @click="openExport">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 16.5v2.25A1.5 1.5 0 004.5 20.25h15A1.5 1.5 0 0021 18.75V16.5"/><path d="M12 3v12m0 0l4.5-4.5M12 15l-4.5-4.5"/></svg>
          Export
        </button>
        <button class="btn ghost" @click="toggleTrace">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 6h16M4 12h10M4 18h7"/></svg>
          Trace ⟷
        </button>
        <button class="btn" @click="openInfo">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><path d="M12 8h.01M11 11h2v5h-2z"/></svg>
          Info
        </button>
      </div>
      <div class="row" style="padding:0 0 10px 0;font-size:13px" v-scope>
        <div class="status">Status: <span>{{ status }}</span></div>
        <div class="status">• sections: <span>{{ sections }}</span></div>
        <div class="status">• tokens: <span>{{ tokenTally }}</span></div>
        <div class="status">• end marker: <span class="kbd">&lt;{{ endMarkerEscaped }}&gt;</span></div>
        <div class="grow"></div>
        <div class="muted">Edit the prompt anytime; applies next turn.</div>
        <span style="display:none" v-effect="persist()"></span>
      </div>
    </div>
  </div>

  <div class="container grid" v-scope>
    <!-- LEFT -->
    <div class="card">
      <div class="head">Source & Prompt</div>
      <div class="body">
        <label>Gemini API Key</label>
        <div class="row">
          <input v-model="apiKey" type="password" placeholder="••••••••••••••••••••••" />
          <button class="btn" @click="saveKey">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M16.5 10.5a4.5 4.5 0 10-9 0 4.5 4.5 0 009 0z"/><path d="M21 21l-4.35-4.35"/></svg>
            Save
          </button>
          <button class="btn" @click="clearKey">Clear</button>
        </div>
        <div class="muted" style="margin-top:4px">Stored locally in your browser.</div>

        <div class="row" style="gap:8px; margin-top:12px">
          <div style="flex:1">
            <label style="margin-top:0">Model</label>
            <select v-model="model" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#fff">
              <option value="gemini-2.5-pro">gemini-2.5-pro</option>
              <option value="gemini-2.0-flash">gemini-2.0-flash</option>
              <option value="gemini-2.0-pro-exp-02-05">gemini-2.0-pro-exp-02-05</option>
              <option value="gemini-1.5-pro">gemini-1.5-pro</option>
            </select>
          </div>
          <div style="width:240px">
            <label style="margin-top:0">Temperature</label>
            <div class="row" style="gap:8px">
              <label style="font-weight:500"><input type="checkbox" v-model="useTemperature"> Enable</label>
              <input :disabled="!useTemperature" v-model.number="temperature" type="number" min="0" max="2" step="0.1" style="width:120px">
            </div>
          </div>
        </div>

        <label style="margin-top:12px">Upload (.pdf or .epub)</label>
        <input id="fileInput" type="file" accept=".pdf,.epub" @change="onFileChange" />
        <div class="muted" style="margin-top:6px">{{ fileInfo }}</div>

        <label style="margin-top:12px">Distillation Prompt (editable)</label>
        <textarea v-model="prompt"></textarea>

        <div style="margin-top:10px;font-weight:600">Run options</div>
        <label style="margin-top:8px"><input type="checkbox" v-model="pauseOnAnomaly"> Pause on anomaly (refusal/empty/loop)</label>
        <div class="row" style="margin-top:6px;gap:8px">
          <div style="flex:1">
            <div class="muted">End marker regex</div>
            <input v-model="endMarker">
          </div>
          <div>
            <div class="muted">Budget: tokens</div>
            <input v-model.number="budgetTokens" type="number" min="0" placeholder="(optional)" style="width:140px">
          </div>
          <div>
            <div class="muted">Budget: time (sec)</div>
            <input v-model.number="budgetTime" type="number" min="0" placeholder="(optional)" style="width:140px">
          </div>
        </div>
        <div class="muted" style="margin-top:8px">No chunking. The book file is uploaded once and re-attached on every turn. Exact request & response are logged in Trace.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="display:flex;flex-direction:column">
      <div class="head">Live Document</div>
      <div class="doc" id="liveDoc"><div class="muted">Output will appear here…</div></div>
    </div>
  </div>

  <!-- Trace Drawer -->
  <div id="trace" class="trace" aria-hidden="true" v-scope>
    <div class="head">
      <div style="font-weight:700">Trace</div>
      <div class="grow"></div>
      <button class="btn" @click="closeTrace">Close</button>
      <button class="btn" @click="downloadTrace">Download trace.json</button>
    </div>
    <div id="traceList" class="list"></div>
  </div>

  <!-- Export modal -->
  <dialog id="exportModal" style="border:none;border-radius:12px;max-width:680px;width:calc(100% - 24px)" v-scope>
    <form method="dialog" style="margin:0">
      <div class="card">
        <div class="head">Export</div>
        <div class="body">
          <label><input id="includeTrace" type="checkbox"> Include trace.json</label>
          <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn primary" @click="copyAll">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M8 7h10a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2V9a2 2 0 012-2z"/><path d="M6 3h10a2 2 0 012 2v2"/></svg>
              Copy all
            </button>
            <button type="button" class="btn" @click="exportMd">.md</button>
            <button type="button" class="btn" @click="exportTxt">.txt</button>
            <button type="button" class="btn" @click="exportPdf">.pdf</button>
            <button id="btnCloseExport" class="btn">Close</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Info modal -->
  <dialog id="infoModal" style="border:none;border-radius:12px;max-width:640px;width:calc(100% - 24px)">
    <form method="dialog" style="margin:0">
      <div class="card">
        <div class="head">About & How-To</div>
        <div class="body">
          <div style="font-weight:600;margin-bottom:6px">Tech Stack</div>
          <ul class="muted" style="margin:0 0 12px 18px">
            <li>Petite‑Vue for UI reactivity</li>
            <li>Google Gemini SDK (@google/genai)</li>
            <li>Marked for Markdown → HTML, jsPDF for PDF export</li>
          </ul>
          <div style="font-weight:600;margin:8px 0 6px">Recreate this with GPT‑5 (or latest)</div>
          <div class="muted">
            1) Build a simple HTML app with Petite‑Vue and a file input. 2) Capture the book file and prompt, then call the OpenAI Responses API with your chosen model (e.g., GPT‑5 when available) and attach the file each turn. 3) Stream responses into a live document and keep a trace log for debugging. Persist API key, model, and prompt in localStorage.
          </div>
          <div style="margin-top:12px;text-align:right">
            <button class="btn">Close</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <div id="toasts" class="toastHost"></div>

  <script type="module">
    import { createApp } from 'https://unpkg.com/petite-vue?module';
    import { GoogleGenAI, createUserContent, createPartFromUri } from 'https://esm.run/@google/genai@0.14.1';

    // Helpers
    const $ = s => document.querySelector(s);
    const el = (tag, cls, html) => { const x=document.createElement(tag); if(cls) x.className=cls; if(html!==undefined) x.innerHTML=html; return x; };
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const estimateTokens = s => Math.ceil((s||'').length/4);
    function sim3(a,b){ const grams=s=>{const t=(s||'').toLowerCase().replace(/\s+/g,' ').trim(); const G=new Set(); for(let i=0;i<Math.max(0,t.length-2);i++) G.add(t.slice(i,i+3)); return G;}; const A=grams(a),B=grams(b); const inter=[...A].filter(x=>B.has(x)).length; const union=new Set([...A,...B]).size||1; return inter/union; }
    function toast(msg,type='info',ms=3500){ const host=$('#toasts'); const n=el('div',`toast ${type}`,msg); host.appendChild(n); setTimeout(()=>n.remove(),ms);} 
    function stripMd(md){ return (md||'').replace(/[>#*_`~\-]+/g,'').replace(/\n{3,}/g,'\n\n'); }
    function download(name, text, type='text/plain;charset=utf-8'){ const blob=new Blob([text],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
    function makePdf(name, md, trace){ const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'}); const margin=56,width=483; const lines=(stripMd(md)||'(empty)').split('\n'); let y=margin; doc.setFont('Times','Normal'); doc.setFontSize(12); for(const line of lines){ const chunk=doc.splitTextToSize(line,width); if(y+chunk.length*16>812){ doc.addPage(); y=margin;} doc.text(chunk,margin,y); y+=chunk.length*16+4; } if(trace){ doc.addPage(); doc.setFontSize(11); const t=JSON.stringify(trace,null,2).split('\n'); let yy=margin; for(const row of t){ const chunk=doc.splitTextToSize(row,width); if(yy+chunk.length*14>812){ doc.addPage(); yy=margin;} doc.text(chunk,margin,yy); yy+=chunk.length*14+2; } } doc.save(name); }

    const DEFAULT_PROMPT = `# Book Deep-Dive Exploration Prompt\n\n**Your Mission:** You are tasked with creating an immersive, in-depth exploration of a book I provide. Your goal is to channel the author's voice and produce a series of thematic deep-dives that, when combined, will read as a single, flowing document—like an extended meditation on the book written by the author themselves.\n\n## For the First Response Only\n\n**Structure your first response in two parts:**\n\n### Part 1: Opening the Journey\n- **Book Introduction**: In the author's voice, introduce the book's core premise and why it was written\n- **The Architecture**: Present a roadmap of all major themes/sections that will be covered across our multi-turn exploration, showing how each builds upon the last\n- **Reading Guide**: Briefly explain how these sections work together to form the complete journey\n\n### Part 2: First Thematic Section\n- Proceed with the first major theme following the standard section structure below\n\n## For All Thematic Sections\n\n**Creating Each Section:**\nBegin each section with a **thematic title** that captures the essence of what you're exploring.\n\n## Our Process\n- I'll provide the book source\n- You'll create the first response with both the opening journey overview and the first thematic section\n- When I respond with "Next", identify the next logical theme and create another complete section\n- Each new section should begin in a way that flows naturally from the previous section\n- When you've covered all major themes and the book's journey is complete, respond only with: \`<end_of_book>\`\n\n## Key Principles\n- **The reader should feel they've read the book itself through your responses**\n- Privilege completeness and depth over conciseness\n- Think of the final combined document as the book's essence, distilled but not diluted\n\n## Remember\nYou're not summarizing or studying the book—you're presenting it in its full richness through the author's own eyes. The reader should finish feeling like they've genuinely experienced the book's complete content, receiving all its wisdom, stories, and insights directly from the source material itself.`;

    createApp({
      // state
      apiKey: localStorage.getItem('distillboard.gemini_key')||'',
      prompt: localStorage.getItem('distillboard.prompt') || DEFAULT_PROMPT,
      endMarker: '<end_of_book>',
      budgetTokens: '',
      budgetTime: '',
      pauseOnAnomaly: true,

      status: 'idle', sections: 0, tokenTally: 0,
      running: false, paused: false,
      history: [], lastAssistant: '',
      fileBlob: null, fileInfo: '',
      trace: [],

      model: localStorage.getItem('distillboard.model') || 'gemini-2.5-pro',
      useTemperature: (localStorage.getItem('distillboard.useTemperature')||'false')==='true',
      temperature: +(localStorage.getItem('distillboard.temperature')||'1.0'),
      ai: null, uploadedFile: null, startTime: 0,

      // computed
      get endMarkerEscaped(){ return this.endMarker.replace(/^<|>$/g,''); },

      // methods
      saveKey(){ const k=this.apiKey.trim(); if(!k){ toast('Empty key not saved','warn'); return; } localStorage.setItem('distillboard.gemini_key',k); toast('API key saved','good'); },
      clearKey(){ localStorage.removeItem('distillboard.gemini_key'); this.apiKey=''; toast('API key cleared','good'); },
      onFileChange(e){ const f=e.target.files?.[0]; this.fileBlob=f||null; this.fileInfo = f? `${f.name} • ${(f.type||'').replace('application/','')} • ${(f.size/1048576).toFixed(2)} MB` : ''; },
      toggleTrace(){ const t=$('#trace'); t.classList.toggle('open'); t?.setAttribute?.('aria-hidden', t.classList.contains('open')?'false':'true'); },
      openTrace(){ const t=$('#trace'); t.classList.add('open'); t?.setAttribute?.('aria-hidden','false'); },
      closeTrace(){ const t=$('#trace'); t.classList.remove('open'); t?.setAttribute?.('aria-hidden','true'); },
      downloadTrace(){ const blob=new Blob([JSON.stringify(this.trace,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='trace.json'; a.click(); URL.revokeObjectURL(a.href); },
      openExport(){ $('#exportModal').showModal(); },
      openInfo(){ $('#infoModal').showModal(); },
      async copyAll(){ const text=this.combinedText(); try{ await navigator.clipboard.writeText(text); toast('Copied combined text','good'); }catch{ download('distillation.txt', text); } },
      exportMd(){ download('distillation.md', this.combinedText(), 'text/markdown;charset=utf-8'); },
      exportTxt(){ download('distillation.txt', this.combinedText()); },
      exportPdf(){ const include = $('#includeTrace').checked ? this.trace : null; makePdf('distillation.pdf', this.combinedText(), include); },

      combinedText(){ return this.history.filter(h=>h.role==='model').map(h=>h.parts.map(p=>p.text||'').join('')).join('\n\n').trim(); },
      appendDoc(md){ const host=$('#liveDoc'); if(host.firstElementChild && host.firstElementChild.classList.contains('muted')) host.innerHTML=''; const sect=el('div','prose'); sect.innerHTML=window.marked.parse(md||''); host.appendChild(sect); host.scrollTo({top: host.scrollHeight, behavior:'smooth'}); },
      resetDoc(){ $('#liveDoc').innerHTML='<div class="muted">Output will appear here…</div>'; },

      async start(){
        if(!this.apiKey.trim()){ toast('Add your Gemini API key first','bad'); return; }
        if(!this.fileBlob){ toast('Upload a PDF/EPUB first','bad'); return; }
        if(!this.prompt.trim()){ toast('Prompt is empty','bad'); return; }

        // reset
        this.resetDoc(); this.history=[]; this.sections=0; this.tokenTally=0; this.lastAssistant=''; this.trace=[]; this.paused=false; this.running=false;
        this.status='uploading';

        // init SDK
        this.ai = new GoogleGenAI({ apiKey: this.apiKey.trim() });

        // upload via Files API and poll ACTIVE
        try{
          this.uploadedFile = await this.ai.files.upload({ file: this.fileBlob, config: { displayName: this.fileBlob.name } });
          let tries=0; while(this.uploadedFile.state==='PROCESSING' && tries<60){ await sleep(2000); this.uploadedFile = await this.ai.files.get({ name: this.uploadedFile.name }); tries++; }
          if(this.uploadedFile.state==='FAILED') throw new Error('File processing failed on Gemini.');
        }catch(e){ this.status='error'; toast('Upload failed: '+(e?.message||'unknown'),'bad',6000); this.pushTrace({request:{step:'files.upload'}, error:this.serializeErr(e), retries:0}); return; }

        this.running=true; this.status='running'; this.startTime=Date.now();

        // First turn
        const filePart = createPartFromUri(this.uploadedFile.uri, this.uploadedFile.mimeType);
        const userFirst = createUserContent([ filePart, 'Begin as instructed: include Opening the Journey (intro, architecture, reading guide) and the first complete thematic section.' ]);
        const req1 = { model: this.model, contents:[ userFirst ], config: this.makeConfig() };
        const [resp1, r1tries, r1err] = await this.callWithRetries(req1);
        if(r1err){ this.finishWithError(r1err, req1, r1tries); return; }
        const text1 = resp1?.text || this.extractText(resp1);
        this.history.push(userFirst); this.history.push({role:'model', parts:[{text:text1}]});
        this.sections+=1; this.tokenTally+=estimateTokens(text1); this.appendDoc(text1);
        this.pushTrace({request:this.sanitize(req1), response:resp1, retries:r1tries});
        const done = await this.postTurnChecks(text1); if(done){ this.cleanFinish(); return; }
        this.nextLoop();
      },

      async nextLoop(){
        while(this.running && !this.paused){
          // budgets
          if(+this.budgetTime>0 && (Date.now()-this.startTime)/1000 > +this.budgetTime){ this.status='time budget reached'; toast('Time budget reached','warn'); break; }
          if(+this.budgetTokens>0 && this.tokenTally >= +this.budgetTokens){ this.status='token budget reached (est)'; toast('Token budget (estimated) reached','warn'); break; }

          const filePart = createPartFromUri(this.uploadedFile.uri, this.uploadedFile.mimeType);
          const nextUser = createUserContent([ filePart, 'Next' ]);
          const req = { model:this.model, contents:[...this.history, nextUser], config: this.makeConfig() };
          const [resp, tries, err] = await this.callWithRetries(req);
          if(err){
            const msg=String(err?.message||'');
            if(/Unsupported file uri/i.test(msg)){
              toast('File reference invalid; re-uploading once…','warn');
              try{ this.uploadedFile = await this.ai.files.upload({ file:this.fileBlob, config:{ displayName:this.fileBlob.name }}); }
              catch(e){ this.finishWithError(err, req, tries); return; }
              continue; // retry next iteration
            }
            this.finishWithError(err, req, tries); return;
          }
          const text = resp?.text || this.extractText(resp);
          this.history.push(nextUser); this.history.push({role:'model', parts:[{text}]});
          this.sections+=1; this.tokenTally+=estimateTokens(text); this.appendDoc(text);
          this.pushTrace({request:this.sanitize(req), response:resp, retries:tries});
          const done = await this.postTurnChecks(text); if(done) break;
        }
        this.cleanFinish();
      },

      togglePause(){ this.paused=!this.paused; toast(this.paused?'Paused':'Resumed', 'info'); if(!this.paused && this.running) this.nextLoop(); },
      stop(){ this.running=false; this.status='stopped'; toast('Stopped','warn'); },

      // helpers
      sanitize(req){ return JSON.parse(JSON.stringify(req)); },
      makeConfig(){ const cfg={ systemInstruction: this.prompt }; if(this.useTemperature){ cfg.generationConfig={ temperature: Number(this.temperature)||0 }; } return cfg; },
      persist(){ try{ localStorage.setItem('distillboard.prompt', this.prompt||''); localStorage.setItem('distillboard.model', this.model||''); localStorage.setItem('distillboard.useTemperature', String(!!this.useTemperature)); localStorage.setItem('distillboard.temperature', String(this.temperature??'')); }catch{} },
      serializeErr(e){ if(!e) return {message:'unknown'}; if(typeof e==='string') return {message:e}; return { message: e.message||'unknown', name:e.name||'Error', raw:e?.response||e?.toString?.() }; },
      pushTrace({request,response,error,retries}){ const ts=new Date().toISOString(); this.trace.push({ts,request,response,error,retries}); const card=el('div','item'); card.appendChild(el('div','',`<b>${error?'Error':'Turn'}</b> <span class=\"muted\" style=\"float:right\">${new Date().toLocaleTimeString()}</span>`)); const rq=el('div','pre'); rq.textContent=JSON.stringify(request,null,2); card.appendChild(el('div','muted','Request:')); card.appendChild(rq); if(response){ const rs=el('div','pre'); rs.textContent=JSON.stringify(response,null,2); card.appendChild(el('div','muted','Response:')); card.appendChild(rs);} if(error){ const er=el('div','pre'); er.textContent=JSON.stringify(error,null,2); card.appendChild(el('div','muted','Error:')); card.appendChild(er);} if(retries>0) card.appendChild(el('div','muted',`Retries: ${retries}`)); $('#traceList').prepend(card); },
      extractText(resp){ const json=resp?.raw || resp; const c=json?.candidates?.[0]; const parts=c?.content?.parts||[]; return parts.map(p=>p.text||'').join(''); },

      async callWithRetries(args){
        let attempt=0, max=5, lastErr=null;
        while(attempt<max){
          try{ const res = await this.ai.models.generateContent(args); return [res, attempt, null]; }
          catch(err){ lastErr=err; const code = (err?.error?.code)||(err?.status)||(err?.response?.status); if(code===429 || String(code).startsWith('5') || /RESOURCE_EXHAUSTED|INTERNAL/i.test(JSON.stringify(err))){ const backoff=Math.min(16000, 1000*Math.pow(2,attempt))*(0.75+Math.random()*0.5); await sleep(backoff); attempt++; continue; } return [null, attempt, err]; }
        }
        return [null, max, lastErr||new Error('Exhausted retries')];
      },

      async postTurnChecks(text){
        const re=new RegExp(String(this.endMarker||'<end_of_book>')+'$');
        if(re.test((text||'').trim())){ this.status='complete'; toast('Distillation complete','good'); return true; }
        if(this.pauseOnAnomaly){
          if(/^\s*(i\s+(can\'t|cannot|won\'t)|as an ai|i\'m unable|i do not have access)/i.test(text||'')){ this.paused=true; this.status='paused (refusal)'; toast('Paused: likely refusal','warn'); return true; }
          if(((text||'').trim().replace(/```[\s\S]*?```/g,'').length)<200){ this.paused=true; this.status='paused (empty/short)'; toast('Paused: response too short','warn'); return true; }
          if(sim3(this.lastAssistant, text)>0.9){ this.paused=true; this.status='paused (loop)'; toast('Paused: response repeating','warn'); return true; }
        }
        this.lastAssistant = text; return false;
      },

      cleanFinish(){ this.running=false; if(this.status==='running') this.status='stopped'; },
      finishWithError(err, req, retries){ this.running=false; this.status='error'; this.pushTrace({request:this.sanitize(req), error:this.serializeErr(err), retries}); toast('API Error: '+(err?.message||'unknown'),'bad',7000); },
    }).mount();
  </script>
</body>
</html>
